###
# Here are the main definitions of paths/names that get repeated often
Define srvroot /usr/local/apache2
Define docroot /usr/local/apache2/htdocs
Define srvname www.example.com

###
# Main
ServerRoot      ${srvroot}
### relative paths will be "relative" to ServerRoot path
DocumentRoot    ${docroot}
PidFile         logs/apache.pid
ServerAdmin     mymail@example.com
ServerName      ${srvname}

###
# Listen directives
Listen 80
Listen 443

###
# EVENT MPM directives for a max of 75 concurrent clients. Quite conservative for testing.
StartServers            1
ServerLimit             3
MinSpareThreads         5
MaxSpareThreads         70
ThreadsPerChild         25
ThreadLimit             25
MaxRequestWorkers       75
MaxConnectionsPerChild  10000000
###
# To set maxkeepaliverequests to around 80 percent of all possible load
# adjust tro your needs
MaxKeepAliveRequests	100

###
# CORE modules needed
LoadModule unixd_module modules/mod_unixd.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule mime_module modules/mod_mime.so

###
# MPM Modules
LoadModule mpm_event_module modules/mod_mpm_event.so

###
# Extra functionality modules
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule filter_module modules/mod_filter.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule headers_module modules/mod_headers.so
LoadModule allowmethods_module modules/mod_allowmethods.so
LoadModule http2_module modules/mod_http2.so

###
# Varios Functionality modules
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
# If you want directory listing (like'ls' command) uncomment 
# this one and set Option Indexes inside the necessary 
# <Directory...> Directive
#LoadModule autoindex_module modules/mod_autoindex.so

###
# SSL modules and server config secure directives
LoadModule ssl_module modules/mod_ssl.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
SSLHonorCipherOrder     off
SSLSessionTickets       off
SSLUseStapling 			on
SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
SSLRandomSeed startup file:/dev/urandom 2048
SSLRandomSeed connect file:/dev/urandom 1024
SSLSessionCache shmcb:${srvroot}/logs/ssl_gcache_data(512000)

###
# Others modules add here ONLY WHEN NEEDED
# You will know when you need a module if apache complains
# about not knowing certain directive you have specified when 
# you try restart, stop, start or check syntax
# (/path/to/httpd --help for commands)
# You can look for which directive is provided by which
# module by searching for it in http://httpd.apache.org/docs/2.4/


###
# User:Group
User daemon
Group daemon

###
# Finetune
Timeout 60
KeepAlive On
KeepAliveTimeout 5
UseCanonicalName off
AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
Protocols h2 http/1.1

###
# Overall Security directives 
RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
ServerTokens Prod
ServerSignature Off
HostnameLookups Off
TraceEnable off
AccessFileName .htaccess
Header always set X-Frame-Options DENY
Header always set X-Content-Type-Options nosniff

###
# If we ever use htacccess, which we shouldnt, we deny
# so they are not visible
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

###
# Directory / of your OS, we always deny.
<Directory />
	Options none
	Require all denied
	AllowOverride none
	AllowMethods GET POST HEAD
</Directory>

###
# Default documentroot
<Directory ${docroot}>
	DirectoryIndex disabled
    AllowOverride None
    Require all granted
</Directory>

###
# Log directives
LogLevel warn
LogFormat "%h %{HTTP_HOST}i %l %u %t [%L] \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %{HTTP_HOST}i %l %u %t [%L] \"%r\" %>s %b" common
ErrorLogFormat "[%{u}t] [%-m:%l] [%L] [pid %P:tid %T] %7F: %E: [client\ %a] %M% ,\ referer\ %{Referer}i"

###
# server config logs, normally access will always be empty
# if we defined our virtualhosts correctly.
# Later we will define a specific log files for each virtualhost
ErrorLog logs/error.log
CustomLog logs/access.log common

###
# Errors
ErrorDocument 400 "Bad Request"
ErrorDocument 401 "Authorization Required"
ErrorDocument 403 "Forbidden"
ErrorDocument 404 "Not Found"
ErrorDocument 405 "Method Not Allowed"
ErrorDocument 406 "Not Acceptable (encoding)"
ErrorDocument 407 "Proxy Authentication Required"
ErrorDocument 408 "Request Timed Out"
ErrorDocument 409 "Conflicting Request"
ErrorDocument 410 "Gone"
ErrorDocument 411 "Content Length Required"
ErrorDocument 412 "Precondition Failed"
ErrorDocument 413 "Request Entity Too Long"
ErrorDocument 414 "Request URI Too Long"
ErrorDocument 415 "Unsupported Media Type"
ErrorDocument 500 "Internal Server Error"
ErrorDocument 501 "Not Implemented"
ErrorDocument 502 "Bad Gateway"
ErrorDocument 503 "Service Unavailable"
ErrorDocument 504 "Gateway Timeout"
ErrorDocument 505 "HTTP Version Not Supported"

###
# Mime
TypesConfig     conf/mime.types

###
# Local FS Documentroot on
# NFS or networked Documentroot set to off
EnableMMAP on
EnableSendfile on

###
# VirtualHost
<VirtualHost *:80>
    DocumentRoot ${docroot}
    ServerName ${srvname}
	ServerAlias example.com
    ErrorLog logs/${srvname}-error.log
    CustomLog logs/${srvname}.log common
	
	###
	# Site content
	### redirect all to SSL virtualhost
	Redirect / https://${srvname}/
</VirtualHost>

###
# VirtualHost SSL
<VirtualHost *:443>
    DocumentRoot ${docroot}
    ServerName ${srvname}
	ServerAlias example.com
    ErrorLog logs/${srvname}-ssl-error.log
    CustomLog logs/${srvname}-ssl.log combined

	SSLEngine on
	SSLCertificateFile conf/server.crt
	SSLCertificateKeyFile conf/server.key

	###
     # Site content
	DirectoryIndex index.html
	<Directory ${docroot}>
		Require all granted
	</Directory>
</VirtualHost>
